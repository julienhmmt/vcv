<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VaultCertsViewer Admin</title>
    <style>
      .vcv-hidden { display: none; }
    </style>
    <link rel="stylesheet" href="/assets/styles.css" />
    <link rel="stylesheet" href="/assets/style-admin.css" />
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
  </head>
  <body>
    <div class="vcv-layout">
      <header class="vcv-header">
        <div class="vcv-header-bar">
          <div class="vcv-header-brand">
            <h1 class="vcv-title">VaultCertsViewer admin</h1>
          </div>
          <div class="vcv-header-actions">
            <button
              id="theme-toggle"
              class="vcv-button vcv-button-icon vcv-theme-toggle"
              type="button"
              title="Toggle dark mode"
              aria-label="Toggle dark mode"
              hx-post="/ui/theme/toggle"
              hx-target="#vcv-theme-sink"
              hx-swap="innerHTML"
              hx-include="#vcv-theme-value"
            >
              <span id="theme-icon" aria-hidden="true"></span>
            </button>
            <input id="vcv-theme-value" name="theme" type="hidden" value="light" />
            <div id="vcv-theme-sink" class="vcv-hidden"></div>
            <a class="vcv-button" href="/">Back to VCV</a>
          </div>
        </div>
      </header>

      <section id="admin-login">
        <div class="admin-login-wrapper">
          <div class="admin-login">
            <div class="admin-login-card">
              <div class="admin-login-header">
                <div class="admin-login-icon">üîê</div>
                <h2 class="admin-login-title">VaultCertsViewer Admin</h2>
                <p class="admin-login-subtitle">Enter the admin password to manage settings.</p>
              </div>
              <div class="admin-login-body">
                <div id="admin-login-error" class="admin-alert admin-alert-error vcv-hidden" role="alert"></div>
                <form id="admin-login-form" class="admin-form">
                  <input type="hidden" id="admin-username" name="username" value="admin" autocomplete="username" required />
                  <div class="admin-form-row">
                    <label class="admin-label" for="admin-password">Password</label>
                    <input class="vcv-input" id="admin-password" name="password" type="password" autocomplete="current-password" required aria-label="Password" autofocus />
                    <span class="admin-field-hint">Use the bcrypt-hashed password set in VCV_ADMIN_PASSWORD.</span>
                  </div>
                  <button class="vcv-button vcv-button-primary vcv-button-full" type="submit">Login</button>
                </form>
              </div>
              <div class="admin-login-footer">
                <p class="admin-login-footer-text"><a href="/">‚Üê Back to VCV</a></p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="admin-panel" class="vcv-hidden">
        <div id="admin-alert-success" class="admin-alert admin-alert-success vcv-hidden" role="status"></div>
        <div id="admin-alert-error" class="admin-alert admin-alert-error vcv-hidden" role="alert"></div>

        <section class="admin-panel-surface">
          <div class="admin-card-header">
            <h2 class="admin-card-title"><span class="admin-card-title-icon">‚öôÔ∏è</span> Settings</h2>
            <div class="admin-actions">
              <button class="vcv-button vcv-button-secondary" id="admin-logout" type="button">Logout</button>
            </div>
          </div>

          <form id="admin-settings-form" class="admin-form">
            <fieldset class="admin-fieldset">
              <legend class="admin-legend"><span class="admin-legend-icon">üìã</span> App</legend>
              <div class="admin-grid">
                <div class="admin-form-row">
                  <label class="admin-label" for="settings-app-port">Port</label>
                  <input class="vcv-input" id="settings-app-port" name="port" type="number" min="1" max="65535" disabled />
                </div>
                <div class="admin-form-row">
                  <label class="admin-label" for="settings-log-level">Log level</label>
                  <input class="vcv-input" id="settings-log-level" name="logLevel" disabled />
                </div>
                <div class="admin-form-row">
                  <label class="admin-label" for="settings-log-format">Log format</label>
                  <input class="vcv-input" id="settings-log-format" name="logFormat" disabled />
                </div>
                <div class="admin-form-row">
                  <label class="admin-label" for="settings-log-output">Log output</label>
                  <input class="vcv-input" id="settings-log-output" name="logOutput" disabled />
                </div>
                <div class="admin-form-row">
                  <label class="admin-label" for="settings-log-file">Log file path</label>
                  <input class="vcv-input" id="settings-log-file" name="logFilePath" disabled />
                </div>
              </div>
            </fieldset>

            <fieldset class="admin-fieldset">
              <legend class="admin-legend"><span class="admin-legend-icon">üîí</span> Certificates</legend>
              <span class="admin-field-hint">Certificates expiring within these thresholds are flagged in the dashboard.</span>
              <div class="admin-grid">
                <div class="admin-form-row">
                  <label class="admin-label" for="settings-expire-critical">Critical threshold (days)</label>
                  <input class="vcv-input" id="settings-expire-critical" name="expireCritical" type="number" min="1" max="3650" />
                </div>
                <div class="admin-form-row">
                  <label class="admin-label" for="settings-expire-warning">Warning threshold (days)</label>
                  <input class="vcv-input" id="settings-expire-warning" name="expireWarning" type="number" min="1" max="3650" />
                </div>
              </div>
            </fieldset>

            <fieldset class="admin-fieldset">
              <legend class="admin-legend"><span class="admin-legend-icon">üåê</span> CORS</legend>
              <div class="admin-grid">
                <div class="admin-form-row admin-form-row-full">
                  <label class="admin-label" for="settings-cors-origins">Allowed origins (comma-separated)</label>
                  <textarea class="vcv-input admin-textarea" id="settings-cors-origins" name="corsOrigins" rows="3" placeholder="e.g. https://example.com, https://other.example.com"></textarea>
                </div>
              </div>
            </fieldset>

            <fieldset class="admin-fieldset">
              <legend class="admin-legend"><span class="admin-legend-icon">üèõÔ∏è</span> Vaults</legend>
              <div class="admin-section-header">
                <div class="admin-section-hint">Configure your Vault instances below.</div>
                <div class="admin-actions">
                  <button class="vcv-button vcv-button-secondary" id="admin-add-vault" type="button">+ Add vault</button>
                </div>
              </div>
              <div id="admin-vaults-list" class="admin-vaults-list"></div>
            </fieldset>

            <div class="admin-actions admin-actions-space">
              <button class="vcv-button vcv-button-primary" type="submit">Save settings.json</button>
            </div>

            <div class="admin-note">
              Changes are persisted to the settings file. A server restart may be required for all changes to take effect.
            </div>
          </form>
        </section>
      </section>
    </div>

    <script>
      const loginSection = document.getElementById('admin-login');
      const panelSection = document.getElementById('admin-panel');
      const loginForm = document.getElementById('admin-login-form');
      const settingsForm = document.getElementById('admin-settings-form');
      const logoutButton = document.getElementById('admin-logout');
      const addVaultButton = document.getElementById('admin-add-vault');
      const vaultsList = document.getElementById('admin-vaults-list');

      function getEl(id) {
        return document.getElementById(id);
      }

      function setValue(id, value) {
        const el = getEl(id);
        if (!el) return;
        el.value = value;
      }

      function setChecked(id, checked) {
        const el = getEl(id);
        if (!el) return;
        el.checked = !!checked;
      }

      function getValue(id) {
        const el = getEl(id);
        if (!el) return '';
        return el.value;
      }

      function getChecked(id) {
        const el = getEl(id);
        if (!el) return false;
        return el.checked;
      }

      function show(el) {
        if (!el) return;
        el.classList.remove('vcv-hidden');
      }

      function hide(el) {
        if (!el) return;
        el.classList.add('vcv-hidden');
      }

      function showError(message) {
        const el = document.getElementById('admin-alert-error');
        if (!el) return;
        el.textContent = message;
        show(el);
        setTimeout(() => hide(el), 6000);
      }

      function showSuccess(message) {
        const el = document.getElementById('admin-alert-success');
        if (!el) return;
        el.textContent = message;
        show(el);
        setTimeout(() => hide(el), 4000);
      }

      function showLoginError(message) {
        const el = document.getElementById('admin-login-error');
        if (!el) return;
        el.textContent = message;
        show(el);
      }

      function clearLoginError() {
        const el = document.getElementById('admin-login-error');
        if (!el) return;
        hide(el);
        el.textContent = '';
      }

      function createVaultRow(vault) {
        const card = document.createElement('div');
        card.className = 'admin-vault-card';
        const mounts = Array.isArray(vault.pki_mounts) ? vault.pki_mounts.join(',') : (vault.pki_mount ? vault.pki_mount : '');
        const enabled = vault.enabled === false ? '' : 'checked';
        const tls = vault.tls_insecure ? 'checked' : '';
        card.innerHTML = `
          <div class="admin-vault-card-header">
            <div class="admin-vault-card-title">
              <input class="vcv-input admin-input" name="vault-id" value="${vault.id || ''}" placeholder="id" required />
              <input class="vcv-input admin-input" name="vault-display" value="${vault.display_name || ''}" placeholder="display name" />
            </div>
            <div class="admin-vault-card-actions">
              <button class="vcv-button vcv-button-danger vcv-button-small" type="button">Remove</button>
            </div>
          </div>
          <div class="admin-vault-card-grid">
            <div class="admin-form-row admin-form-row-full">
              <label class="admin-label">Address</label>
              <input class="vcv-input admin-input" name="vault-address" value="${vault.address || ''}" required />
            </div>
            <div class="admin-form-row">
              <label class="admin-label">Token</label>
              <input class="vcv-input admin-input" name="vault-token" type="password" value="${vault.token || ''}" required />
            </div>
            <div class="admin-form-row">
              <label class="admin-label">PKI mounts</label>
              <input class="vcv-input admin-input" name="vault-mounts" value="${mounts}" />
            </div>
            <div class="admin-form-row">
              <label class="admin-label">TLS insecure</label>
              <label class="admin-toggle">
                <input name="vault-tls" type="checkbox" ${tls} />
                <span class="admin-toggle-label">Enable</span>
              </label>
            </div>
            <div class="admin-form-row">
              <label class="admin-label">Enabled</label>
              <label class="admin-toggle">
                <input name="vault-enabled" type="checkbox" ${enabled} />
                <span class="admin-toggle-label">Enable</span>
              </label>
            </div>
          </div>
        `;
        const removeButton = card.querySelector('button');
        if (removeButton) {
          removeButton.addEventListener('click', () => card.remove());
        }
        return card;
      }

      function renderVaults(vaults) {
        if (!vaultsList) return;
        vaultsList.innerHTML = '';
        vaults.forEach((vault) => {
          vaultsList.appendChild(createVaultRow(vault));
        });
      }

      function readVaultsFromTable() {
        if (!vaultsList) return [];
        const cards = Array.from(vaultsList.querySelectorAll('.admin-vault-card'));
        return cards.map((card) => {
          const id = card.querySelector('input[name="vault-id"]').value.trim();
          const displayName = card.querySelector('input[name="vault-display"]').value.trim();
          const address = card.querySelector('input[name="vault-address"]').value.trim();
          const token = card.querySelector('input[name="vault-token"]').value;
          const mountsValue = card.querySelector('input[name="vault-mounts"]').value;
          const pkiMounts = mountsValue.split(',').map((v) => v.trim()).filter((v) => v !== '');
          const tlsInsecure = card.querySelector('input[name="vault-tls"]').checked;
          const enabled = card.querySelector('input[name="vault-enabled"]').checked;
          return {
            id,
            display_name: displayName,
            address,
            token,
            pki_mount: pkiMounts.length > 0 ? pkiMounts[0] : 'pki',
            pki_mounts: pkiMounts.length > 0 ? pkiMounts : ['pki'],
            tls_insecure: tlsInsecure,
            enabled,
          };
        });
      }

      function applySettingsToForm(settings) {
        setValue('settings-app-env', settings.app?.env || 'dev');
        setValue('settings-app-port', settings.app?.port || '');
        setValue('settings-log-level', settings.app?.logging?.level || '');
        setValue('settings-log-format', settings.app?.logging?.format || '');
        setValue('settings-log-output', settings.app?.logging?.output || '');
        setValue('settings-log-file', settings.app?.logging?.file_path || '');
        setValue('settings-expire-critical', settings.certificates?.expiration_thresholds?.critical || '');
        setValue('settings-expire-warning', settings.certificates?.expiration_thresholds?.warning || '');
        const origins = Array.isArray(settings.cors?.allowed_origins) ? settings.cors.allowed_origins : [];
        setValue('settings-cors-origins', origins.join(','));
        setChecked('settings-cors-credentials', !!settings.cors?.allow_credentials);
        renderVaults(Array.isArray(settings.vaults) ? settings.vaults : []);
      }

      function buildSettingsFromForm() {
        const envValue = getValue('settings-app-env');
        const env = envValue !== '' ? envValue : 'dev';
        const port = parseInt(getValue('settings-app-port'), 10);
        const logLevel = getValue('settings-log-level').trim();
        const logFormat = getValue('settings-log-format').trim();
        const logOutput = getValue('settings-log-output').trim();
        const logFilePath = getValue('settings-log-file').trim();
        const critical = parseInt(getValue('settings-expire-critical'), 10);
        const warning = parseInt(getValue('settings-expire-warning'), 10);
        const corsOriginsRaw = getValue('settings-cors-origins');
        const corsOrigins = corsOriginsRaw.split(',').map((v) => v.trim()).filter((v) => v !== '');
        const corsCredentials = getChecked('settings-cors-credentials');
        const vaults = readVaultsFromTable();
        return {
          app: {
            env,
            port: Number.isFinite(port) ? port : 0,
            logging: {
              level: logLevel,
              format: logFormat,
              output: logOutput,
              file_path: logFilePath,
            },
          },
          certificates: {
            expiration_thresholds: {
              critical: Number.isFinite(critical) ? critical : 0,
              warning: Number.isFinite(warning) ? warning : 0,
            },
          },
          cors: {
            allowed_origins: corsOrigins,
            allow_credentials: corsCredentials,
          },
          vaults,
        };
      }

      async function getSettings() {
        const response = await fetch('/api/admin/settings');
        if (!response.ok) {
          throw new Error(`Failed to load settings (${response.status})`);
        }
        return response.json();
      }

      async function saveSettings(settings) {
        const response = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings),
        });
        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || `Failed to save settings (${response.status})`);
        }
      }

      async function bootstrap() {
        try {
          const settings = await getSettings();
          hide(loginSection);
          show(panelSection);
          applySettingsToForm(settings);
        } catch {
          show(loginSection);
          hide(panelSection);
        }
      }

      if (loginForm) {
        loginForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          clearLoginError();
          const username = document.getElementById('admin-username').value;
          const password = document.getElementById('admin-password').value;
          try {
            const response = await fetch('/api/admin/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password }),
            });
            if (!response.ok) {
              throw new Error('Invalid credentials');
            }
            await bootstrap();
            document.getElementById('admin-password').value = '';
          } catch (error) {
            showLoginError(error.message);
          }
        });
      }

      if (logoutButton) {
        logoutButton.addEventListener('click', async () => {
          try {
            await fetch('/api/admin/logout', { method: 'POST' });
          } finally {
            show(loginSection);
            hide(panelSection);
          }
        });
      }

      if (addVaultButton) {
        addVaultButton.addEventListener('click', () => {
          const row = createVaultRow({
            id: '',
            display_name: '',
            address: '',
            token: '',
            pki_mount: 'pki',
            pki_mounts: ['pki'],
            tls_insecure: false,
            enabled: true,
          });
          if (vaultsList) {
            vaultsList.appendChild(row);
          }
        });
      }

      if (settingsForm) {
        settingsForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          try {
            const settings = buildSettingsFromForm();
            await saveSettings(settings);
            showSuccess('Settings saved');
          } catch (error) {
            showError(error.message);
          }
        });
      }

      function safeApplyTheme() {
        const key = 'vcv-theme';
        const stored = (typeof localStorage !== 'undefined') ? localStorage.getItem(key) : null;
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
        const themeInput = document.getElementById('vcv-theme-value');
        if (themeInput) {
          themeInput.value = theme;
        }
      }

      function initAdmin() {
        initLoginForm();
        initLogout();
        initAddVault();
        initVaultRemoval();
        // Reuse global theme toggle logic from app-htmx.js when available, otherwise fallback
        if (typeof applyThemeFromStorage === 'function') {
          applyThemeFromStorage();
        } else {
          safeApplyTheme();
        }
      }

      document.addEventListener('DOMContentLoaded', initAdmin);
    </script>
    <script src="/assets/htmx.min.js"></script>
    <script src="/assets/app-htmx.js"></script>
  </body>
</html>
