apiVersion: v1
kind: Namespace
metadata:
  name: vcv
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vcv-sa
  namespace: vcv
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vcv
  namespace: vcv
  labels:
    app: vcv
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vcv
  template:
    metadata:
      labels:
        app: vcv
    spec:
      serviceAccountName: vcv-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: vcv
          image: jhmmt/vcv:1.6
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 52000
              protocol: TCP
          volumeMounts:
            - name: vcv-settings
              mountPath: /app/settings.json
              subPath: settings.json
              readOnly: true
          resources:
            requests:
              cpu: "100m"
              memory: "64Mi"
            limits:
              cpu: "500m"
              memory: "128Mi"
          readinessProbe:
            httpGet:
              path: /api/ready
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 20
          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
      volumes:
        - name: vcv-settings
          secret:
            secretName: vcv-settings
---
apiVersion: v1
kind: Secret
metadata:
  name: vcv-settings
  namespace: vcv
type: Opaque
stringData:
  settings.json: |
    {
      "app": {
        "env": "prod",
        "port": 52000,
        "logging": {
          "level": "info",
          "format": "json",
          "output": "stdout",
          "file_path": "/var/log/app/vcv.log"
        }
      },
      "cors": {
        "allowed_origins": [],
        "allow_credentials": true
      },
      "certificates": {
        "expiration_thresholds": {
          "critical": 7,
          "warning": 30
        }
      },
      "vaults": [
        {
          "id": "vault-main",
          "address": "https://vault-prod.example.com:8200",
          "token": "change-me",
          "pki_mounts": [
            "pki",
            "pki_dev",
            "pki_stage",
            "pki_production"
          ],
          "display_name": "Vault",
          "tls_ca_cert_base64": "BASE64_PEM_CA_BUNDLE",
          "tls_ca_cert": "",
          "tls_ca_path": "",
          "tls_server_name": "vault.service.consul",
          "tls_insecure": false,
          "enabled": true
        },
        {
          "id": "vault-dev",
          "address": "https://vault-dev.example.com:8200",
          "token": "change-me",
          "pki_mounts": [
            "pki",
            "pki_corporate",
            "pki_external",
            "pki_partners"
          ],
          "display_name": "Vault dev",
          "tls_ca_cert_base64": "BASE64_PEM_CA_BUNDLE",
          "tls_ca_cert": "",
          "tls_ca_path": "",
          "tls_server_name": "vault-dev.service.consul",
          "tls_insecure": false,
          "enabled": true
        }
      ]
    }
---
apiVersion: v1
kind: Service
metadata:
  name: vcv
  namespace: vcv
  labels:
    app: vcv
spec:
  selector:
    app: vcv
  ports:
    - name: http
      port: 52000
      targetPort: http
      protocol: TCP
  type: ClusterIP
